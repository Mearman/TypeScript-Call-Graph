<!DOCTYPE html>

<head>
  <title>TypeScript Call Graph</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <style>
    .observablehq--inspect {
      display: none;
    }

    .heading {
      font-family: sans-serif;
      margin: 20px 5px 0;
    }

    a {
      color: black;
      display: block;
      font-family: sans-serif;
      font-size: 12px;
      margin: 10px;
      text-decoration: none;
    }

    #functionsList {
      position: absolute;
      background: white;
      border-right: 1px solid black;
    }

    #graphDiv {
      margin-left: 200px;
    }
  </style>
</head>

<body>

  <div id="functionsList"></div>

  <div id="graphDiv"></div>

  <script>

    fetch('http://localhost:3000/all')
      .then((response) => {
        return response.json();
      })
      .then((data) => {

        data.sort();

        const everyFunc = data.map(function (func) {
              return '<a href="index.html?start=' + func + '">' + func + '</a>';
            }).join('');

        document.getElementById('functionsList').innerHTML = everyFunc;

      });

  </script>

  <script type="module">
    import define from "./graph.js";
    import { Runtime, Library, Inspector } from "/vendor/runtime.js";

    const runtime = new Runtime();

    const temp = document.getElementById('graphDiv');

    const main = runtime.module(define, Inspector.into(temp));

    // Save to SVG & PNG
    setTimeout(() => {
      // Thank you @gustavohenke for the Gist: https://gist.github.com/gustavohenke/9073132
      var svg = document.querySelector("svg");
      var svgData = new XMLSerializer().serializeToString(svg);

      var canvas = document.createElement("canvas");
      var ctx = canvas.getContext("2d");

      var svgSize = svg.getBoundingClientRect();
      canvas.width = svgSize.width;
      canvas.height = svgSize.height;

      var img = document.createElement("img");
      img.setAttribute("src", "data:image/svg+xml;base64," + btoa(svgData));

      img.onload = function () {
        ctx.drawImage(img, 0, 0);

        const pngBase64 = canvas.toDataURL("image/png");

        const a = document.createElement("a");
        a.download = "callgraph.png";
        a.href = pngBase64;
        a.innerHTML = "download as PNG";
        temp.appendChild(a);

        const svgBase64 = "data:image/svg+xml;base64," + btoa(svgData);

        const b = document.createElement("a");
        b.download = "callgraph.svg";
        b.href = svgBase64;
        b.innerHTML = "download as SVG";
        temp.appendChild(b);

      };

    }, 350);


  </script>
</body>
